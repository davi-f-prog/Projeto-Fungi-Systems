<!DOCTYPE html>
<html lang="br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--  <script
      src="https://kit.fontawesome.com/9e43a3780f.js"
      crossorigin="anonymous"
    ></script>-->

  <title>Pagina do Cliente</title>
  <script src="js/anima-menu.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
  <script type="text/javascript" src="https://www.chartjs.org/samples/latest/utils.js"></script>
  <link rel="stylesheet" href="css/header-paginacliente.css">
  <link rel="stylesheet" href="css/paginaCliente.css" />
  <style>
    canvas {
      -moz-user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }
  </style>
</head>
<body>
  <div class="sidebar" id="mySidebar">
    <a href="#" class="closebtn" onclick="closeNav()">x</a>
    <span>Olá, <b id="b_usuario"></b></span>
    <a href="#">Dashboard</a>
    <a href="suporte.html">Suporte</a>
    <a href="home.html">Sair</a>
  </div>
  <div class="header">
    <img src="./imagens/Logo.png" class="logo" onclick="openNav()">
  </div>
  <div class="main" id="main">
    <div class="container">
      <h1 class="titulo-dashboard">Fungi Systems<br>Dashboard</h1>
      <div class="box temp">
        <h1>100%</h1>
        <h2>Media hora temperatura</h2>
      </div>
      <div class="box humi">
        <h1>80%</h1>
        <h2>Média hora umidade</h2>
      </div>
      <div class="box lumi">
        <h1>20%</h1>
        <h2>Média hora luminosidade </h2>
      </div>
      <div class="graficos">
        <h2>Gráficos</h2>
        <div class="pag_sensores" id="id_sensores">
          <section>
            <h3>Média: <label id='average'>0.00</label></h3>
            <h3>Média Hora: <label id='averageHour'>0.00</label></h3>
          </section>
          <div class="temphumi">
            <div id="div_aguarde">Dados sendo obtidos...</div>
            <canvas id="canvas_grafico"></canvas>
          </div>
        </div>
      </div>
      <!-- Sensores -->
      <div class="graph g-1">
        <h3>Sensores</h3>
      </div>
      <!-- Calendario -->
      <div class="graph g-2">
        <h2>Calendario</h2>
      </div>
      <div class="grafico_luminosidade">
        <h2>Gráfico de Luminosidade</h2>
      </div>
    </div>
</body>

</html>
<script>

  window.onload = obterDadosGrafico;

  // verificar_autenticacao();

  // neste JSON tem que ser 'labels', 'datasets' etc, 
  // porque é o padrão do Chart.js
  var dados = {
    type: 'bar',
    labels: [],
    datasets: [
      {
        yAxisID: 'y-temperatura',
        label: 'Temperatura',
        borderColor: window.chartColors.red,
        backgroundColor: window.chartColors.red,
        fill: false,
        data: []
      },
      {
        yAxisID: 'y-umidade',
        label: 'Umidade',
        borderColor: window.chartColors.blue,
        backgroundColor: window.chartColors.blue,
        fill: false,
        data: []
      }
      // {
      //   yAxisID: 'y-luminosidade',
      //   label: 'Luminosidade',
      //   borderColor: window.chartColors.yellow,
      //   backgroundColor: window.chartColors.yellow,
      //   fill: false,
      //   data: []
      // }
    ]
  };


  // só mexer se quiser alterar o tempo de atualização
  // ou se souber o que está fazendo!
  function atualizarGrafico() {

    fetch('/leituras/tempo-real', { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);

          // tirando e colocando valores no gráfico
          dados.labels.shift(); // apagar o primeiro
          dados.labels.push(novoRegistro.momento_grafico); // incluir um novo momento
          dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
          dados.datasets[1].data.shift();  // apagar o primeiro de umidade
          // dados.datasets[2].data.shift();  // apagar o primeiro de luminosidade
          dados.datasets[0].data.push(novoRegistro.temperatura); // incluir uma nova leitura de temperatura
          dados.datasets[1].data.push(novoRegistro.umidade); // incluir uma nova leitura de umidade
          // dados.datasets[2].data.push(novoRegistro.luminosidade); // incluir uma nova leitura de luminosidade
          window.grafico_linha.update();

          setTimeout(atualizarGrafico, 5000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        setTimeout(atualizarGrafico, 5000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }

  // altere aqui as configurações do gráfico
  // (tamanhos, cores, textos, etc)
  function configurarGrafico() {
    var configuracoes = {
      responsive: true,
      animation: { duration: 500 },
      hoverMode: 'index',
      stacked: false,
      title: {
        display: true,
        text: 'Histórico recente de temperatura e umidade'
      },
      scales: {
        yAxes: [{
          type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
          display: true,
          position: 'left',
          id: 'y-temperatura',
        }, {
          type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
          display: true,
          position: 'right',
          id: 'y-umidade',

          // grid line settings
          gridLines: {
            drawOnChartArea: false, // only want the grid lines for one axis to show up
          },
        }
        // , {
        //   type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
        //   display: true,
        //   position: 'right',
        //   id: 'y-luminosidade',

        //   // grid line settings
        //   gridLines: {
        //     drawOnChartArea: false, // only want the grid lines for one axis to show up
        //   },
        // }
      ],
      }
    };

    return configuracoes;
  }

  // altere aqui como os dados serão exibidos
  // e como são recuperados do BackEnd
  function obterDadosGrafico() {

    fetch('/leituras/ultimas', { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {

          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

          resposta.reverse();

          for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            // aqui, após 'registro.' use os nomes 
            // dos atributos que vem no JSON 
            // que gerou na consulta ao banco de dados

            dados.labels.push(registro.momento_grafico);

            dados.datasets[0].data.push(registro.temperatura);
            dados.datasets[1].data.push(registro.umidade);
            // dados.datasets[2].data.push(registro.luminosidade);
          }
          console.log(JSON.stringify(dados));

          div_aguarde.style.display = 'none';

          plotarGrafico(dados);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }

  // só altere aqui se souber o que está fazendo!
  function plotarGrafico(dados) {
    console.log('iniciando plotagem do gráfico...');

    var ctx = canvas_grafico.getContext('2d');
    window.grafico_linha = Chart.Line(ctx, {
      data: dados,
      options: configurarGrafico()
    });

    setTimeout(atualizarGrafico, 5000);
  }



   var dados = {
    type: 'bar',
    labels: [],
    datasets: [
      {
        yAxisID: 'y-temperatura',
        label: 'Temperatura',
        borderColor: window.chartColors.red,
        backgroundColor: window.chartColors.red,
        fill: false,
        data: []
      },
      {
        yAxisID: 'y-umidade',
        label: 'Umidade',
        borderColor: window.chartColors.blue,
        backgroundColor: window.chartColors.blue,
        fill: false,
        data: []
      }
      // {
      //   yAxisID: 'y-luminosidade',
      //   label: 'Luminosidade',
      //   borderColor: window.chartColors.yellow,
      //   backgroundColor: window.chartColors.yellow,
      //   fill: false,
      //   data: []
      // }
    ]
  };


  // só mexer se quiser alterar o tempo de atualização
  // ou se souber o que está fazendo!
  function atualizarGrafico() {

    fetch('/leituras/tempo-real', { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);

          // tirando e colocando valores no gráfico
          dados.labels.shift(); // apagar o primeiro
          dados.labels.push(novoRegistro.momento_grafico); // incluir um novo momento
          dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
          dados.datasets[1].data.shift();  // apagar o primeiro de umidade
          // dados.datasets[2].data.shift();  // apagar o primeiro de luminosidade
          dados.datasets[0].data.push(novoRegistro.temperatura); // incluir uma nova leitura de temperatura
          dados.datasets[1].data.push(novoRegistro.umidade); // incluir uma nova leitura de umidade
          // dados.datasets[2].data.push(novoRegistro.luminosidade); // incluir uma nova leitura de luminosidade
          window.grafico_linha.update();

          setTimeout(atualizarGrafico, 5000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        setTimeout(atualizarGrafico, 5000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }

  // altere aqui as configurações do gráfico
  // (tamanhos, cores, textos, etc)
  function configurarGrafico() {
    var configuracoes = {
      responsive: true,
      animation: { duration: 500 },
      hoverMode: 'index',
      stacked: false,
      title: {
        display: true,
        text: 'Histórico recente de temperatura e umidade'
      },
      scales: {
        yAxes: [{
          type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
          display: true,
          position: 'left',
          id: 'y-temperatura',
        }, {
          type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
          display: true,
          position: 'right',
          id: 'y-umidade',

          // grid line settings
          gridLines: {
            drawOnChartArea: false, // only want the grid lines for one axis to show up
          },
        }
        // , {
        //   type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
        //   display: true,
        //   position: 'right',
        //   id: 'y-luminosidade',

        //   // grid line settings
        //   gridLines: {
        //     drawOnChartArea: false, // only want the grid lines for one axis to show up
        //   },
        // }
      ],
      }
    };

    return configuracoes;
  }

  // altere aqui como os dados serão exibidos
  // e como são recuperados do BackEnd
  function obterDadosGrafico() {

    fetch('/leituras/ultimas', { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {

          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

          resposta.reverse();

          for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            // aqui, após 'registro.' use os nomes 
            // dos atributos que vem no JSON 
            // que gerou na consulta ao banco de dados

            dados.labels.push(registro.momento_grafico);

            dados.datasets[0].data.push(registro.temperatura);
            dados.datasets[1].data.push(registro.umidade);
            // dados.datasets[2].data.push(registro.luminosidade);
          }
          console.log(JSON.stringify(dados));

          div_aguarde.style.display = 'none';

          plotarGrafico(dados);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }

  // só altere aqui se souber o que está fazendo!
  function plotarGrafico(dados) {
    console.log('iniciando plotagem do gráfico...');

    var ctx = canvas_grafico.getContext('2d');
    window.grafico_linha = Chart.Line(ctx, {
      data: dados,
      options: configurarGrafico()
    });

    setTimeout(atualizarGrafico, 5000);
  }


</script>