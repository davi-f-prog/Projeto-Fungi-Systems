<script>

var dados2 = {
    type: 'bar',
    labels: [],
    datasets: [
      {
        yAxisID: 'y-temperatura',
        label: 'Temperatura',
        borderColor: window.chartColors.red,
        backgroundColor: window.chartColors.red,
        fill: false,
        data: []
      },
      {
        yAxisID: 'y-umidade',
        label: 'Umidade',
        borderColor: window.chartColors.blue,
        backgroundColor: window.chartColors.blue,
        fill: false,
        data: []
      }
      // {
      //   yAxisID: 'y-luminosidade',
      //   label: 'Luminosidade',
      //   borderColor: window.chartColors.yellow,
      //   backgroundColor: window.chartColors.yellow,
      //   fill: false,
      //   data: []
      // }
    ]
  };


  // só mexer se quiser alterar o tempo de atualização
  // ou se souber o que está fazendo!
  function atualizarGrafico2() {

    fetch('/leituras/tempo-real', { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (novoRegistro) {

          console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);

          // tirando e colocando valores no gráfico
          dados2.labels.shift(); // apagar o primeiro
          dados2.labels.push(novoRegistro.momento_grafico); // incluir um novo momento
          dados2.datasets[0].data.shift();  // apagar o primeiro de temperatura
          dados2.datasets[1].data.shift();  // apagar o primeiro de umidade
          // dados.datasets[2].data.shift();  // apagar o primeiro de luminosidade
          dados2.datasets[0].data.push(novoRegistro.temperatura); // incluir uma nova leitura de temperatura
          dados2.datasets[1].data.push(novoRegistro.umidade); // incluir uma nova leitura de umidade
          // dados.datasets[2].data.push(novoRegistro.luminosidade); // incluir uma nova leitura de luminosidade
          window.grafico_linha2.update();

          setTimeout(atualizarGrafico2, 5000);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        setTimeout(atualizarGrafico2, 5000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }

  // altere aqui as configurações do gráfico
  // (tamanhos, cores, textos, etc)
  function configurarGrafico2() {
    var configuracoes2 = {
      responsive: true,
      animation: { duration: 500 },
      hoverMode: 'index',
      stacked: false,
      title: {
        display: true,
        text: 'Histórico recente de temperatura e umidade'
      },
      scales: {
        yAxes: [{
          type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
          display: true,
          position: 'left',
          id: 'y-temperatura',
        }, {
          type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
          display: true,
          position: 'right',
          id: 'y-umidade',

          // grid line settings
          gridLines: {
            drawOnChartArea: false, // only want the grid lines for one axis to show up
          },
        }
        // , {
        //   type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
        //   display: true,
        //   position: 'right',
        //   id: 'y-luminosidade',

        //   // grid line settings
        //   gridLines: {
        //     drawOnChartArea: false, // only want the grid lines for one axis to show up
        //   },
        // }
      ],
      }
    };

    return configuracoes2;
  }

  // altere aqui como os dados serão exibidos
  // e como são recuperados do BackEnd
  function obterDadosGrafico2() {

    fetch('/leituras/ultimas', { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {

          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

          resposta.reverse();

          for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            // aqui, após 'registro.' use os nomes 
            // dos atributos que vem no JSON 
            // que gerou na consulta ao banco de dados

            dados2.labels.push(registro.momento_grafico);

            dados2.datasets[0].data.push(registro.temperatura);
            dados2.datasets[1].data.push(registro.umidade);
            // dados.datasets[2].data.push(registro.luminosidade);
          }
          window.data = dados2;
              window.dados2.update();

          console.log(JSON.stringify(dados2));

          div_aguarde.style.display = 'none';

          plotarGrafico2(dados2);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }

  // só altere aqui se souber o que está fazendo!
  function plotarGrafico2(dados2) {
    console.log('iniciando plotagem do gráfico...');

    var ctx2 = canvas_grafico2.getContext('2d');
    window.grafico_linha2 = Chart.Line(ctx2, {
      data: dados2,
      options: configurarGrafico2()
    });

    setTimeout(atualizarGrafico2, 5000);
  }

</script>  